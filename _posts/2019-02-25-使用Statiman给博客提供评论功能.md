---
title: "使用Statiman给博客提供评论功能（一）"
uuid: b546517d-2f04-497b-b47e-45ad88368266
excerpt: "本文主要介绍Jekyll + Staticman + GitHub搭建静态博客"
last_modified_at: 2019-02-25T09:55:00
comments: true
toc: true
toc_label: "目录"
toc_icon: "columns"
categories:
  - 技术
tags:
  - Jekyll
---

### 简介
Staticman是一个给静态博客提供评论功能的模块，其基本原理是将用户提交的评论内容转换成格式化文本（yaml、json），然后以文件方式上传到指定github库。Staticman[源码](https://github.com/eduardoboucas/staticman)，[官网](https://staticman.net/)。

基本流程：
<svg style="position: absolute; width: 0; height: 0;" width="0" height="0" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <symbol id="brand-staticman" viewBox="0 0 225.45 168.4" class="anim-github__truck">
      <title>Staticman</title>
      <path id="brand-staticman-body" d="M202.661,82.953V55.94c1.935,0,3.5-1.567,3.5-3.5c0-1.935-1.565-3.5-3.5-3.5v-7.505c0-2.505-0.236-4.955-0.664-7.339
      c-0.009-0.057-0.004-0.111-0.015-0.167c-0.043-0.237-0.096-0.474-0.144-0.708c-0.018-0.076-0.03-0.153-0.047-0.229
      c-1.631-7.871-5.485-15.043-11.203-20.791c-2.523-2.536-5.353-4.726-8.395-6.506c-0.312-0.186-0.634-0.343-0.949-0.52
      c-0.188-0.104-0.375-0.204-0.562-0.307c-0.479-0.254-0.955-0.504-1.441-0.739c-0.169-0.082-0.341-0.154-0.51-0.233
      c-0.82-0.383-1.652-0.738-2.496-1.066c-0.336-0.131-0.672-0.264-1.012-0.387c-0.385-0.137-0.771-0.268-1.157-0.394
      c-0.416-0.136-0.836-0.264-1.258-0.387c-0.341-0.099-0.683-0.201-1.024-0.291c-0.73-0.192-1.472-0.372-2.22-0.523
      c-0.233-0.05-0.47-0.082-0.705-0.126c-0.567-0.106-1.139-0.205-1.715-0.287c-0.333-0.048-0.667-0.088-1.002-0.128
      c-0.489-0.06-0.981-0.107-1.478-0.147c-0.348-0.029-0.692-0.06-1.041-0.08c-0.567-0.033-1.141-0.048-1.713-0.057
      C161.685,0.019,161.458,0,161.23,0c-0.198,0-0.394,0.02-0.59,0.021c-0.628,0.009-1.254,0.026-1.875,0.062
      c-0.371,0.022-0.739,0.055-1.106,0.085c-0.479,0.041-0.955,0.091-1.429,0.148c-0.386,0.046-0.772,0.09-1.157,0.146
      c-0.502,0.075-0.998,0.167-1.494,0.262c-0.713,0.132-1.418,0.283-2.119,0.454c-0.262,0.062-0.523,0.123-0.787,0.191
      c-0.549,0.146-1.094,0.299-1.635,0.465c-0.108,0.034-0.22,0.071-0.33,0.106c-9.912,3.126-18.383,9.91-23.619,19.259
      c-0.127,0.225-0.258,0.449-0.381,0.677c-0.107,0.205-0.23,0.4-0.338,0.608c-0.06,0.114-0.105,0.232-0.154,0.352
      c-2.821,5.598-4.426,11.911-4.426,18.597v7.505c-1.933,0-3.5,1.565-3.5,3.5c0,1.933,1.567,3.5,3.5,3.5v26.969
      c-9.459,0.94-18.581,4.091-26.554,9.212c-2.277,1.454-4.455,3.061-6.471,4.771c-0.031,0.024-0.062,0.053-0.092,0.081
      c-0.048,0.042-0.102,0.09-0.135,0.12c-0.706,0.666-1.371,1.266-2.04,1.835c-1.786,1.522-3.67,2.913-5.639,4.167
      c-0.035,0.028-0.058,0.067-0.098,0.093c-2.429,1.509-4.451,2.609-6.362,3.469c-1.494,0.675-3.031,1.212-4.646,1.717
      c-0.209,0.07-0.42,0.133-0.631,0.2c-0.169,0.052-0.344,0.104-0.515,0.155c-4.752,1.459-9.691,2.211-14.757,2.211
      c-13.082,0-25.259-4.957-34.417-13.548c4.265,1.501,8.787,2.298,13.387,2.298c10.164,0,19.912-3.873,27.303-10.63
      c1.345,6.435,4.178,12.481,8.253,17.65c1.846-0.558,3.56-1.136,5.202-1.878c0.544-0.245,1.105-0.519,1.677-0.81
      c-5.663-6.353-8.913-14.579-9.025-23.159c-0.02-1.509-1.004-2.835-2.442-3.291c-1.441-0.457-3.008,0.062-3.892,1.283
      C51.619,87.519,41.497,92.69,30.82,92.69c-9.389,0-18.403-3.989-24.731-10.945c-1.058-1.162-2.762-1.478-4.165-0.769
      c-1.404,0.708-2.163,2.265-1.857,3.807c0.035,0.174,0.076,0.349,0.119,0.524c0.002,0.011,0.001,0.021,0.004,0.03
      c8.308,35.907,35.138,65.679,70.019,77.69c7.912,2.728,16.178,4.53,24.569,5.354c0.114,0.014,0.228,0.019,0.342,0.019
      c0.865,0,1.704-0.32,2.351-0.906c0.732-0.664,1.149-1.604,1.149-2.594v-18.67c0-8.852,1.809-17.4,5.379-25.418
      c2.458-5.529,5.701-10.641,9.643-15.244l-3.829-2.268l4.589,1.38c0.002-0.004,0.004-0.007,0.007-0.01l23.528,6.72
      c1.231,0.574,2.504,1.092,3.793,1.572v-7.526c-5.915-2.615-11.06-6.43-14.94-11.22v-0.949V86.16V55.94h1.393v9.5
      c0,6.893,5.605,12.5,12.5,12.5h5c6.484,0,11.832-4.967,12.438-11.298c0.034-0.198,0.062-0.4,0.062-0.608
      c0-1.682,1.365-3.05,3.05-3.05c1.683,0,3.05,1.368,3.05,3.05c0,0.205,0.026,0.403,0.061,0.599
      c0.604,6.335,5.951,11.309,12.439,11.309h5c6.893,0,12.5-5.607,12.5-12.5v-9.5h1.381V86.13v7.144v0.955
      c-3.881,4.782-9.021,8.594-14.931,11.207v7.527c1.286-0.479,2.554-0.996,3.784-1.568l23.533-6.722
      c0.018,0.019,0.029,0.035,0.048,0.055l4.737-1.426l-3.953,2.342c3.436,4.021,6.344,8.437,8.654,13.173
      c0.588,1.207,1.812,1.965,3.146,1.965c0.067,0,0.14-0.002,0.211-0.006c1.409-0.085,2.632-1.01,3.096-2.346
      c0.974-2.797,1.466-5.748,1.466-8.778C225.45,96.106,215.682,84.974,202.661,82.953 M164.23,55.44h-6v-2h6V55.44z M195.661,48.94
      h-1.381h-3.619h-19.594c-0.432-1.442-1.754-2.5-3.337-2.5h-13c-1.583,0-2.905,1.058-3.337,2.5H131.79h-3.607h-1.393v-7.505
      c0-3.739,0.608-7.338,1.717-10.712c1.104,1.047,2.287,1.989,3.553,2.813c0.363,0.195,1.137,0.591,2.275,1.091
      c1.623,0.722,4.039,1.528,7.017,1.977c1.485,0.222,3.11,0.344,4.829,0.354c0.42-0.012,0.885,0.004,1.281-0.032
      c0.451-0.027,0.906-0.058,1.365-0.088c0.938-0.033,1.816-0.185,2.74-0.287c0.917-0.098,1.859-0.326,2.807-0.486
      c0.943-0.2,1.89-0.461,2.852-0.675c0.943-0.281,1.902-0.552,2.854-0.854c0.941-0.341,1.897-0.646,2.832-1.017
      c1.879-0.716,3.731-1.51,5.522-2.366c0.89-0.442,1.771-0.88,2.644-1.314c0.86-0.46,1.709-0.914,2.545-1.359
      c1.643-0.952,3.236-1.859,4.709-2.793c0.752-0.445,1.451-0.927,2.142-1.372c0.687-0.452,1.364-0.863,1.987-1.307
      c1.244-0.881,2.424-1.639,3.424-2.376c1.01-0.729,1.904-1.344,2.605-1.896c1.426-1.078,2.262-1.676,2.262-1.676
      s-0.717,0.729-2.012,1.974c-0.64,0.63-1.464,1.341-2.391,2.182c-0.918,0.854-2.016,1.743-3.208,2.72
      c-0.847,0.666-1.767,1.373-2.728,2.081c3.399,6.8,8.896,11.218,15.072,11.977c0.113,1.133,0.174,2.282,0.174,3.444v7.505
      L195.661,48.94L195.661,48.94z M177.247,99.039c-0.931-0.654-2.121-0.815-3.191-0.435l-12.823,4.58l-12.821-4.58
      c-1.072-0.382-2.265-0.222-3.193,0.435c-0.932,0.656-1.483,1.725-1.483,2.861v19c0,1.138,0.554,2.205,1.483,2.859
      c0.599,0.424,1.305,0.641,2.017,0.641c0.396,0,0.794-0.067,1.177-0.204l12.823-4.579l12.823,4.579
      c0.383,0.137,0.779,0.204,1.177,0.204c0.712,0,1.418-0.217,2.017-0.641c0.933-0.654,1.483-1.724,1.483-2.859v-19
      C178.73,100.762,178.178,99.695,177.247,99.039"></path>
      <path id="brand-staticman-eyes-background" d="M151.181,65.44c0,3.033-2.47,5.5-5.5,5.5h-5c-3.033,0-5.5-2.467-5.5-5.5v-9.5h16
      V65.44z M187.28,65.44c0,3.033-2.467,5.5-5.5,5.5h-5c-3.033,0-5.5-2.467-5.5-5.5v-9.5h16V65.44z"></path>
      <path id="brand-staticman-eyes" d="M175.28,61.44c0-2.205,1.795-4,4-4c0.09,0,0.176,0.021,0.264,0.026c-0.162,0.289-0.264,0.618-0.264,0.974
      c0,1.103,0.896,2,2,2c0.639,0,1.201-0.306,1.567-0.772c0.269,0.536,0.433,1.133,0.433,1.772c0,2.206-1.795,4-4,4
      S175.28,63.646,175.28,61.44 M139.181,61.44c0-2.205,1.794-4,4-4c0.09,0,0.175,0.021,0.263,0.026
      c-0.162,0.289-0.263,0.618-0.263,0.974c0,1.103,0.896,2,2,2c0.638,0,1.198-0.306,1.565-0.772c0.27,0.536,0.435,1.133,0.435,1.772
      c0,2.206-1.795,4-4,4C140.975,65.44,139.181,63.646,139.181,61.44"></path>
      <path id="brand-staticman-bow" d="M157.73,113.434l-7,2.5v-9.067l7,2.5V113.434z M171.73,115.934l-7-2.5v-4.067l7-2.5V115.934z"></path>
    </symbol>
  </defs>
</svg>
<link rel="stylesheet" href="/assets/css/staticman.css">
<div class="anim col col--2-2 col--1-2@tablet">
  <div class="anim-browser">
    <header class="anim-title-bar">
      <span class="anim-title-bar__button anim-title-bar__button--close"></span>
      <span class="anim-title-bar__button anim-title-bar__button--min"></span>
      <span class="anim-title-bar__button anim-title-bar__button--max"></span>
      <span class="anim-title-bar__address">&nbsp;</span>
    </header>
    <section class="anim-browser__content">
      <h1>Zhang Hongtao</h1>
      <p class="anim-label"></p>
      <p class="anim-text-field"><span id="anim-text-field-1">这个网站很酷</span></p>
      <p class="anim-label anim-label--large"></p>
      <p class="anim-text-field anim-text-field--large"><span id="anim-text-field-2" data-text="大神，请问你的这个动画是怎么实现的？">大神</span><span class="anim-cursor">|</span></p>
      <div id="anim-submit-button" class="anim-button">Submit</div>
    </section>
  </div>

  <div class="anim-middleman">
    <div class="anim-middleman__box">
      <svg class="anim-middleman__logo">
        <use xlink:href="#brand-staticman"></use>
      </svg>
      <span class="anim-middleman__fan"></span>
      <span class="anim-middleman__fan anim-middleman__fan--right"></span>  
    </div>
    <div class="anim-middleman__package">
      <span class="anim-middleman__package-text anim-middleman__package-text--dark">POST</span>
      <span class="anim-middleman__package-text anim-middleman__package-text--light">FILE</span>    
    </div>
  </div>
  
  <div class="anim-github">
    <svg class="anim-github__logo" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="512" height="512" viewBox="0 0 512 512">
      <path d="M256 0c-141.385 0-256 114.615-256 256s114.615 256 256 256 256-114.615 256-256-114.615-256-256-256zM408.028 408.028c-19.759 19.758-42.756 35.266-68.354 46.093-6.503 2.75-13.107 5.164-19.8 7.246v-38.367c0-20.167-6.917-35-20.75-44.5 8.667-0.833 16.625-2 23.875-3.5s14.917-3.667 23-6.5 15.333-6.208 21.75-10.125 12.583-9 18.5-15.25 10.875-13.333 14.875-21.25 7.167-17.417 9.5-28.5 3.5-23.292 3.5-36.625c0-25.833-8.417-47.833-25.25-66 7.667-20 6.833-41.75-2.5-65.25l-6.25-0.75c-4.333-0.5-12.125 1.333-23.375 5.5s-23.875 11-37.875 20.5c-19.833-5.5-40.417-8.25-61.75-8.25-21.5 0-42 2.75-61.5 8.25-8.833-6-17.208-10.958-25.125-14.875s-14.25-6.583-19-8-9.167-2.292-13.25-2.625-6.708-0.417-7.875-0.25-2 0.333-2.5 0.5c-9.333 23.667-10.167 45.417-2.5 65.25-16.833 18.167-25.25 40.167-25.25 66 0 13.333 1.167 25.542 3.5 36.625s5.5 20.583 9.5 28.5 8.958 15 14.875 21.25 12.083 11.333 18.5 15.25 13.667 7.292 21.75 10.125 15.75 5 23 6.5 15.208 2.667 23.875 3.5c-13.667 9.333-20.5 24.167-20.5 44.5v39.115c-7.549-2.247-14.99-4.902-22.3-7.994-25.597-10.827-48.594-26.335-68.353-46.093-19.758-19.759-35.267-42.756-46.093-68.354-11.199-26.479-16.878-54.631-16.878-83.674s5.679-57.195 16.879-83.675c10.827-25.597 26.335-48.594 46.093-68.353s42.756-35.267 68.353-46.093c26.48-11.2 54.632-16.879 83.675-16.879s57.195 5.679 83.675 16.879c25.598 10.827 48.595 26.335 68.354 46.093 19.758 19.758 35.266 42.756 46.093 68.353 11.199 26.48 16.878 54.632 16.878 83.675s-5.679 57.195-16.879 83.675c-10.827 25.597-26.335 48.595-46.093 68.353z"></path>
    </svg>
    <svg class="anim-github__truck" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1024" height="1024" viewBox="0 0 1024 1024">
      <path d="M794.624 366.24c-5.952-8.896-15.936-14.24-26.624-14.24h-32c-17.696 0-32 14.304-32 32v192c0 17.696 14.304 32 32 32h128c17.696 0 32-14.304 32-32v-48c0-6.304-1.888-12.512-5.376-17.76l-96-144zM864 576h-128v-192h32l96 144v48zM1007.872 490.752l-128-192c-17.856-26.784-47.744-42.752-79.872-42.752h-128v-64c0-52.928-43.072-96-96-96h-480c-52.928 0-96 43.072-96 96v352c0 52.928 43.072 96 96 96v0 96c0 52.928 43.072 96 96 96h36.544c14.304 55.072 64 96 123.488 96 59.424 0 109.12-40.928 123.424-96h169.024c14.304 55.072 64 96 123.488 96 59.424 0 109.12-40.928 123.424-96h36.608c52.928 0 96-43.072 96-96v-192c0-19.008-5.568-37.44-16.128-53.248zM96 576c-17.664 0-32-14.304-32-32v-352c0-17.696 14.336-32 32-32h480c17.696 0 32 14.304 32 32v352c0 17.696-14.304 32-32 32h-480zM352.032 864c-35.36 0-64-28.672-64-64s28.64-64 64-64c35.328 0 64 28.672 64 64s-28.704 64-64 64zM768 864c-35.36 0-64-28.672-64-64s28.64-64 64-64c35.328 0 64 28.672 64 64s-28.672 64-64 64zM960 736c0 17.696-14.304 32-32 32h-36.576c-14.304-55.072-64-96-123.424-96-59.488 0-109.184 40.928-123.488 96h-169.024c-14.304-55.072-64-96-123.424-96-59.488 0-109.184 40.928-123.488 96h-36.576c-17.664 0-32-14.304-32-32v-96h416c52.928 0 96-43.072 96-96v-224h128c10.688 0 20.672 5.344 26.624 14.24l128 192c3.488 5.248 5.376 11.456 5.376 17.76v192z"></path>
    </svg>
  </div>
</div>
<script async="" src="//www.google-analytics.com/analytics.js"></script>
<script async="" src="/assets/js/intro-animation.js"></script>

### 使用官方的instance 

#### 1. 添加staticman到repository

通过访问staticman的api，将用户的评论数据以文件形式提交到自己的repository，因此需要将staticmanapp添加为自己repository的合作者，使其有commit权限。具体步骤为点击repository的Setting页面，选择Collaborators菜单，搜索用户名staticmanapp，添加到合作者。

![staticman-step1.png]({{site.url}}/assets/img/staticman-step1.png){: .align-center}

在当前状态下，邀请只是等待确认状态，为了使staticman接受邀请，需要你打开如下URL（GET请求）：

```
https://api.staticman.net/v2/connect/{your GitHub username}/{your repository name}
```

正常情况下，返回结果应该为`OK!`。

**注意：**随着Staticman的流行，越来越多的人使用Staticman，造成staticmanapp已经是很多repository的合作者，已经达到了GitHub的上限，所以当访问上面api时，返回结果会是`Invitation not found`；如果staticmanapp不能接受作为自己repository的合作者就无法提交文件，使用官方instance会阻塞在当前步骤。
{: .notice--warning}

**好消息:**找到另一个public instance，GitHub的合作者是StaticmanLab，api地址是`https://staticman3.herokuapp.com/`，帮助手册参考`参考资料`中的后两个链接。
{: .notice--info}

#### 2. 创建配置文件

staticman会在repository的根目录下寻找`staticman.yml`文件查看配置项，该配置文件记录了接受的字段，提交的repository的分支名称，提交评论文件的命名规则、格式、保存路径，是否需要验证码，评论是否需要博主审核……所有配置项的说明可以参考[官方文档](https://staticman.net/docs/configuration)。

**注意：**如果你按照官方文档的步骤，复制[staticman.sample.yml](https://github.com/eduardoboucas/staticman/blob/master/staticman.sample.yml)文件作为自己的配置文件，你就会掉进一个大坑之中。
{: .notice--warning}

当你提交评论数据的时候会报错：
```json
{
    "success": false,
    "data": [
        "allowedFields",
        "branch",
        "format",
        "path"
    ],
    "rawError": {
        "_smErrorCode": "MISSING_CONFIG_FIELDS",
        "data": [
            "allowedFields",
            "branch",
            "format",
            "path"
        ]
    },
    "errorCode": "MISSING_CONFIG_FIELDS"
}
```
这是由于配置文件的格式错误，应该将配置文件中的`comments`注释掉。可参考[文件]({{site.url}}/assets/file/staticman.sample.yml)。

**注意：**如果你使用的是[Staticman官网](https://staticman.net/docs/)的[api](https://api.staticman.net)，你应该注释掉`comments`；如果你使用的是[Vincent Tam](https://vincenttam.gitlab.io/)的[api](https://staticman3.herokuapp.com)，你应该保留`comments`，正如[Vincent Tam](https://vincenttam.gitlab.io/)在本博文后面的评论。:)（@2019年2月28日）

#### 3. 提交评论数据
可以以`POST`方式访问以下URL提交评论数据:
```
https://api.staticman.net/v2/entry/{GITHUB USERNAME}/{GITHUB REPOSITORY}/{BRANCH}/{PROPERTY (optional)}
```
![staticman-step3.png]({{site.url}}/assets/img/staticman-step3.png){: .align-center}

### 自己搭建instance

#### 1. 准备工作
- Node.js 4.8.3+  
- npm  
- GitHub账户的[个人访问token](https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line)，这个GitHub账户不能是repository的所有者  
- [SSH key](https://help.github.com/en/articles/connecting-to-github-with-ssh)

#### 2. 安装服务
a. 克隆repository，安装依赖包：
```shell
git clone git@github.com:eduardoboucas/staticman.git
cd staticman
npm install
```

b. 拷贝实例配置文件作为development配置文件：
```shell
cp config.sample.json config.development.json
```

c. 编辑配置文件，填入之前准备的`GitHub access token`和`SSH key`，以及服务运行的port。点击[此处](https://staticman.net/docs/api)查看所有配置项。

d. 启动服务
```shell
npm start
```

#### 3. 设置repository
可以参考使用官方的instance，将`GitHub access token`对应的GitHub用户添加为你的repository的合作者中，通过访问以下`GET`请求接受邀请：
```
https://{your staticman url}/v2/connect/{your GitHub username}/{your repository name}
```
通过访问以下`POST`请求提交用户评论数据：
```
https://{your staticman url}/v2/entry/{GITHUB USERNAME}/{GITHUB REPOSITORY}/{BRANCH}/{PROPERTY (optional)}
```

### 参考资料
- [Staticman源码](https://github.com/eduardoboucas/staticman)  
- [Staticman官网](https://staticman.net/)  
- [Staticman指导文档](https://staticman.net/docs/)  
- [minimal-mistakes主题配置指导](https://mmistakes.github.io/minimal-mistakes/docs/configuration/#static-based-comments-via-staticman)  
- [https://vincenttam.gitlab.io/post/2018-09-16-staticman-powered-gitlab-pages/2/](https://vincenttam.gitlab.io/post/2018-09-16-staticman-powered-gitlab-pages/2/)
- [https://github.com/VincentTam/TestStaticmanLab](https://github.com/VincentTam/TestStaticmanLab)